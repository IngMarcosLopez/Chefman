define(["N/ui/dialog","N/format","N/search","N/url","N/runtime"],function(e,t,l,n,a){function i(e,t,l,n){var a=[];try{var i=s(e,t,l,n);if(0==i.length)return a;for(var r=0;r<i.length;r++){for(var u=i[r],c={sublist_line_num:r+1,sublist_line_changed:"F"},d=0;d<t.length;d++){var m=o(t[d],!1),f=m.searchType;if("none"!=f){var g={name:m.id};null!=m.searchSummary&&(g.summary=m.searchSummary),null!=m.searchFormula&&(g.formula=m.searchFormula),null!=m.join&&(g.join=m.join);var p=m.name,h=u.getValue(g);if("checkbox"==m.type&&(h="true"===h||!0===h?"T":"F"),"select"==m.type&&"value"!=f)if(V(m.source)&&V(m.selectOPtions)&&"valueText"!=f)h=u.getText(g);else{var y=p+"_display_name";c[y]=u.getText(g)}c[p]=h}else null!=m.defaultValue&&(c[m.name]=m.defaultValue)}a.push(c)}}catch(e){log.debug("执行getSearchResultData方法出错",e)}return a}function s(e,t,l,n){var a=u(t),i=r(t);(V(l)||parseInt(l)<1)&&(l=1),(V(n)||parseInt(n)>1e3)&&(n=1e3);var s=(parseInt(l)-1)*parseInt(n),o=parseInt(l)*parseInt(n);return c(e,i,a,s,o)}function r(e){for(var t=[],l=0;l<e.length;l++){var n=o(e[l],!1);if("none"!=n.searchType){var a={};a.name=n.id,null!=n.searchSort&&(a.sort=n.searchSort),null!=n.searchSummary&&(a.summary=n.searchSummary),null!=n.searchFormula&&(a.formula=n.searchFormula),null!=n.join&&(a.join=n.join),t.push(a)}}return t}function u(e){for(var t=[],l=0;l<e.length;l++){var n=o(e[l],!0);if(null!=n&&(!V(n.filterValues)||"isnotempty"==n.filterOperator||"isempty"==n.filterOperator)){var a={name:n.id,operator:n.filterOperator};null!=n.join&&(a.join=n.join),null!=n.searchFormula&&(a.formula=n.searchFormula),"isnotempty"!=n.filterOperator&&"isempty"!=n.filterOperator&&(a.values=n.filterValues),t.push(a)}}return t}function o(e,t){if(null!=t&&t&&V(e.filter))return null;var l=e.id,n=e.asias;V(n)&&(n=e.id);var a=null;V(e.join)||(a=e.join);var i="value",s=null,r=null,u=null,o=null,c="is",d=null;if(!V(e.search)){var m=e.search;V(m.type)||(i=m.type),V(m.summary)||(s=m.summary),V(m.formula)||(r=m.formula),V(m.sort)||(u=m.sort),V(m.defaultValue)||(o=m.defaultValue)}if(!V(e.filter)){var f=e.filter;V(f.operator)||(c=f.operator),V(f.values)||(d=f.values)}var g="text";V(e.type)||(g=e.type);var p="inline";return V(e.displayType)||(p=e.displayType),{id:l,name:n,type:g,displayType:p,join:a,searchType:i,searchSummary:s,searchFormula:r,searchSort:u,defaultValue:o,filterOperator:c,filterValues:d}}function c(e,t,n,a,i){var s=l.create({type:e,columns:t,filters:n});return s.run().getRange({start:a,end:i})}function d(){F();var e=m(),t=e.sublistConfig.summaryHtml;return jQuery("#bsworksSummaryBar").html(t),e}function m(){var e=JSON.parse(a.getCurrentSession().get({name:"bsworks_suitelet_filters_conofig"})),t=JSON.parse(a.getCurrentSession().get({name:"bsworks_suitelet_sublist_conofig"})),l=JSON.parse(a.getCurrentSession().get({name:"bsworks_suitelet_formFields_conofig"})),n={filtersConfig:e,sublistConfig:t,formFieldsConfig:l};return n}function f(e,t,l,n,a){null==a&&(a="custom_mask");for(var i=0;i<t.length;i++){var s=t[i],r="custpage_"+s.id+"_button",u=document.getElementById(r);"custpage_search_button"==r?u.addEventListener("click",p.bind(null,e,r,l,null)):"custpage_reset_button"==r?u.addEventListener("click",h.bind(null,e,r,l,null)):"custpage_exportexcel_button"==r?u.addEventListener("click",b.bind(null,e,r,n,null)):C(r)}}function g(e,t,l,n,a){var i=[],s=e.currentRecord,r=s.getLineCount({sublistId:l});if(0==r)return C(t),i;for(var u=[],o=[],c=0;c<r;c++){var d=s.getSublistValue({sublistId:l,fieldId:"sublist_line_changed",line:c});if(!a||d){var m={};m.sublist_line_num=s.getSublistValue({sublistId:l,fieldId:"sublist_line_num",line:c});for(var f=0;f<n.length;f++){var g=n[f],p=V(g.asias)?g.id:g.asias;m[p]=s.getSublistValue({sublistId:l,fieldId:p,line:c})}o.push(m);var h=s.getSublistValue({sublistId:l,fieldId:"sublist_checkbox",line:c});h&&u.push(m)}}return i=0==u.length?o:u,i}function p(t,l,n,a){try{for(var i=t.currentRecord,s=n.fields,r=0;r<s.length;r++){var u=s[r];if(null!=u.required&&u.required){var o=i.getValue(u.id);if(V(o))return void e.alert({title:"提示",message:"过滤器 - "+u.label+"不能为空！"})}}y(i,n,!1)}catch(t){console.log(t),e.alert({title:"错误提示",message:t.message})}finally{C(l,a)}}function h(t,l,n,a){try{var i=t.currentRecord;y(i,n,!0)}catch(t){console.log(t),e.alert({title:"错误提示",message:t.message})}finally{C(l,a)}}function y(e,t,l){var a=v(e,t.fields,l);console.log("parameters",a);var i=n.resolveScript({scriptId:"customscript_"+t.suiteletScriptName,deploymentId:"customdeploy_"+t.suiteletScriptName,params:a});setWindowChanged(window,!1),window.location.href="https://"+n.resolveDomain({hostType:n.HostType.APPLICATION})+i}function v(e,t,l){for(var n={pageInit:l},a={},i=0;i<t.length;i++){var s=t[i],r="",u=s.id;V(s.defaultValue)||(r=s.defaultValue),l||(r=e.getValue(s.id),"date"==s.type&&(r=e.getText(s.id)),null!=s.type&&"select"==s.type&&(a[u+"_display_name"]=e.getText(s.id))),a[u]=r}return n.defaultValues=JSON.stringify(a),n}function b(t,l,n,a,i){try{for(var s="序号",r=[],u={},o=n.sublistFields,c=0;c<o.length;c++){var d=o[c],m="inline";if(V(d.displayType)||(m=d.displayType),"hidden"!=m){var f=d.id;V(d.asias)||(f=d.asias);var g=null;V(d.type)||(g=d.type),null==g||"float"!=g&&"integer"!=g&&"currency"!=g||(u[f]=0),s+=","+d.label;var p={id:f,type:g,displayType:m,excel:d.excel};r.push(p)}}s+="\n";var h=t.currentRecord,y="custpage_subitem_list";V(n.id)||(y=n.id),null==i&&(i=x(h,y,r,!0)),console.log("doExportExcel",i);var v="";for(c=0;c<i.length;c++){var b=i[c];for(var _ in b)if("sublist_checkbox"!=_){var I=b[_];if(null!=u[_]?(V(I)&&(I=0),u[_]=parseFloat(u[_])+parseFloat(I)):(-1!=(I+"").indexOf(",")&&(I='"'+I+'"'),"boolean"==typeof I&&(I=I?"是":"否")),s+=I+",",c==i.length-1)if("sublist_line_num"==_)v+="合计,";else if(null!=u[_]){var k=u[_];k=k.toFixed(2),v+=k+","}else v+=","}s+="\n"}s+=v+"\n";var S="data:text/csv;charset=utf-8,\ufeff"+encodeURIComponent(s),E=document.createElement("a");E.href=S,E.download=n.title+".csv",E.click()}catch(t){console.log(t),e.alert({title:"错误提示",message:t.message})}finally{C(l,a)}}function _(e,t,l){var n=[],a=[];null==t&&(t="custpage_subitem_list");var i=e.getLineCount({sublistId:t});if(0==i)return n;for(var s=0;s<i;s++){var r={sublist_line_num:s+1},u=e.getSublistValue({sublistId:t,fieldId:"sublist_checkbox",line:s});V(u)&&(u=!1),r.sublist_checkbox=u;for(var o=0;o<l.length;o++){var c=l[o],d=c.id;V(c.asias)||(d=c.asias);var m=e.getSublistValue({sublistId:t,fieldId:d,line:s});r[d]=m}n.push(r),u&&a.push(r)}return 0==a.length?n:a}function x(e,t,l,n){var a=[],i=[];null==t&&(t="custpage_subitem_list");var s=e.getLineCount({sublistId:t});if(0==s)return a;for(var r=0;r<s;r++){var u={sublist_line_num:r+1},o=e.getSublistValue({sublistId:t,fieldId:"sublist_checkbox",line:r});V(o)&&(o=!1),u.sublist_checkbox=o;for(var c=0;c<l.length;c++){var d=l[c],m=d.id;V(d.asias)||(m=d.asias);var f="";if(f=null!=d.type&&"date"==d.type?e.getSublistText({sublistId:t,fieldId:m,line:r}):null!=d.type&&"select"==d.type&&null!=d.displayType&&"entry"==d.displayType?e.getSublistText({sublistId:t,fieldId:m,line:r}):null!=d.type&&"select"==d.type&&null!=d.excel&&"text"==d.excel.type?e.getSublistText({sublistId:t,fieldId:m,line:r}):e.getSublistValue({sublistId:t,fieldId:m,line:r}),n&&null!=d.excel){var g=d.excel;V(g.valuePrefix)||(f=g.valuePrefix+f),V(g.valueSuffix)||(f+=g.valueSuffix)}u[m]=f}a.push(u),o&&i.push(u)}return 0==i.length?a:i}function I(e,t,l){var n=x(e,t,l),a=A(l,n);jQuery("#bsworksSummaryBar").html(a)}function k(e,t,l,n){var a="全  选",i="   取消全选   ";return null==l&&(l="custpage_subitem_list"),null==n&&(n="sublist_checkbox"),E(e,t,a,i,l,n)}function S(e,t,l,n){var a="   对账标记全选   ",i="   对账标记取消全选   ";return null==l&&(l="custpage_subitem_list"),null==n&&(n="custrecord_amt_prepare_whether_reconcile"),E(e,t,a,i,l,n)}function E(t,l,n,a,i,s){var r=document.getElementById(l),u=!0;-1!=r.value.indexOf(a)&&(u=!1);try{var o=t.currentRecord,c=o.getLineCount({sublistId:i});if(0==c)return;for(var d=0;d<c;d++)o.selectLine({sublistId:i,line:d}),o.setCurrentSublistValue({sublistId:i,fieldId:s,value:u});o.commitLine({sublistId:i}),r.value=u?a:n}catch(t){console.log(t),e.alert({title:"错误提示",message:t.message})}finally{C(l)}}function F(e){var t="执行中，请稍后...",l="custom_mask";if(null!=e&&null!=e.message&&(t=e.message),null!=e&&null!=e.maskId&&(l=e.maskId),document.getElementById(l))return document.getElementById(l).style.display="block",!0;var n=document.createElement("div");n.id=l,n.style.display="none",n.style.left="0px",n.style.top="0px",n.style.bottom="0px",n.style.right="0px",n.style.position="fixed",n.style.zIndex=99999,n.style.background="rgba(0,0,0,0.1)",n.style.width="100%";var a=T();n.style.height=a+"px";var i="https://7336086.app.netsuite.com/core/media/media.nl?id=28692&c=7336086&h=Xq73GtcFjvOXxvafAbgoQcjgS3AXq1xJxZTSpEeBW10uzNKe";n.innerHTML="<div style='font-size:18px; text-align: center; line-height:"+a+"px; font-weight: bold;'><img src='"+i+"'/>"+t+"</div>",document.body.appendChild(n)}function T(){var e=0;if(document.body.clientHeight&&document.documentElement.clientHeight)e=document.body.clientHeight<document.documentElement.clientHeight?document.body.clientHeight:document.documentElement.clientHeight;else e=document.body.clientHeight>document.documentElement.clientHeight?document.body.clientHeight:document.documentElement.clientHeight;return e}function H(e,t){if(!V(e)){V(t)&&(t="custom_mask"),console.log("showLoadingMask",e,t);var l=document.getElementById(e);l.disabled=!0,document.getElementById(t).style.display="block"}}function w(e){null!=e&&""!=e||(e="custom_mask"),document.getElementById(e)&&(document.getElementById(e).style.display="none")}function C(e,t){if(null!=e&&""!=e){var l=document.getElementById(e);null!=typeof l&&(l.disabled=!1)}w(t)}function V(e){return null===e||""===e||void 0===e}function L(e){return V(e)?"":t.format({value:e,type:"date"})}function j(e){return V(e)?"":t.parse({value:e,type:"date"})}function O(e,t){if(0==V(e)||0==V(t)){var l=new Date;return 1==V(e)&&(l.setFullYear(2010),e=L(l)),1==V(t)&&(l.setFullYear(2050),t=L(l)),[e,t]}return null}function B(e,t,l,n,a){e=(e+"").replace(/[^0-9+-Ee.]/g,""),a=a||"ceil";var i=isFinite(+e)?+e:0,s=isFinite(+t)?Math.abs(t):0,r=void 0===n?",":n,u=void 0===l?".":l,o="",c=function(e,t){var l=Math.pow(10,t);return""+parseFloat(Math[a](parseFloat((e*l).toFixed(2*t))).toFixed(2*t))/l};o=(s?c(i,s):""+Math.round(i)).split(".");for(var d=/(-?\d+)(\d{3})/;d.test(o[0]);)o[0]=o[0].replace(d,"$1"+r+"$2");return(o[1]||"").length<s&&(o[1]=o[1]||"",o[1]+=new Array(s-o[1].length+1).join("0")),o.join(u)}function N(e){var t=new Date;return 0==e?t:(t.setMonth(t.getMonth()-e),t)}function R(e){var t=new Date;return 0==e?t:(t.setFullYear(t.getFullYear()-e),t)}function D(e,t){for(var l in null==t&&(t={}),e)t[l]=e[l];return t}function M(e,t){null==t&&(t=" : ");var l=e.split(t);return l.length>1?l[l.length-1]:subsidiaryName}function A(e,t){for(var l="",n=z(e,t),a=0;a<n.length;a++){var i=n[a],s=i.hasSelected?i.selectedTotal:i.allTotal;s=B(s,2,".",","),l+="<span id='total_"+i.id+"' style='margin-left:30px;'>"+i.label+"合计："+s+"</span>"}return l}function z(e,t){for(var l=[],n=0;n<e.length;n++){var a=e[n];if(null!=a.summary&&a.summary){var i=a.id;V(a.asias)||(i=a.asias),l.push({id:i,label:a.label})}}if(0==l.length)return summaryHtml;for(var s=0;s<l.length;s++){var r=l[s],u=!1,o=0,c=0;for(n=0;n<t.length;n++){var d=t[n],m=!!d.sublist_checkbox;m&&(u=!0),V(d[r.id])||(o=parseFloat(o)+parseFloat(d[r.id]),m&&(c=parseFloat(c)+parseFloat(d[r.id])))}o=o.toFixed(2),c=c.toFixed(2),r.allTotal=o,r.selectedTotal=c,r.hasSelected=u}return l}function P(e){var t='var custscript_buttonId=document.getElementById("custscript_buttonId");custscript_buttonId.addEventListener("click",function(){custscript_buttonId.disabled=!0,document.getElementById("custom_mask").style.display="block"});';return t=t.replace(/(custscript_buttonId)/g,e),t}function J(){var e="https://7336086-sb1.app.netsuite.com/core/media/media.nl?id=19959&c=7336086_SB1&h=_ugln9_2g7QWoBtinG0wXTQ3Z9Am0lxAEj4HLW1Tf_ntUzOl";return'var message="执行中，请稍后...",maskId="custom_mask",mask=document.createElement("div");mask.id=maskId,mask.style.display="none",mask.style.left="0px",mask.style.top="0px",mask.style.bottom="0px",mask.style.right="0px",mask.style.position="fixed",mask.style.zIndex=99999,mask.style.background="rgba(0,0,0,0.1)",mask.style.width="100%";var maskHeight=0;maskHeight=document.body.clientHeight&&document.documentElement.clientHeight?document.body.clientHeight<document.documentElement.clientHeight?document.body.clientHeight:document.documentElement.clientHeight:document.body.clientHeight>document.documentElement.clientHeight?document.body.clientHeight:document.documentElement.clientHeight,mask.style.height=maskHeight+"px",mask.innerHTML="<div style=\'font-size:18px; text-align: center; line-height:"+maskHeight+"px; font-weight: bold;\'><img src=\''+e+'\'/>"+message+"</div>",document.body.appendChild(mask);'}function Q(e,t,l){return V(e)&&(e="success"),V(t)&&(t="操作成功"),{status:e,message:t,data:l}}function Y(e,t){return V(e)&&(e="操作成功"),{status:"success",message:e,data:t}}function q(e,t){return{status:"fail",message:e,data:t}}if(-1!=a.accountId.indexOf("7336086"))return{getSearchResultDataList:i,doReset:h,doSearch:p,doExportExcel:b,doClientPageInit:d,showLoadingMask:H,clearLoadingMask:C,createLoadingMask:F,doAddEventListener:f,getSublistDatalist:x,getSublistValueDatalist:_,doShowSublistSummary:I,doSublistRowCheckedAll:k,doSublistCostCheckedAll:S,doGetSublistChangedData:g,doGetSessionSuiteletConfig:m,doCopyData:D,getResponseObject:Q,getSuccessResponse:Y,getFailResponse:q,isNullOrEmpty:V,dateToString:L,stringToDate:j,substractMonthDate:N,substractYearhDate:R,handleFilterRangeDate:O,getNultistageLastName:M,numberThousandsFormat:B,calSublistSummaryFields:z,getSublistSummaryHtml:A,getUserEventButtonScript:P,doCreateLoadingMask:J}});