define(["../../plugin/bsworks/bsworksUtil-2.0","N/record","N/format","N/https","N/ui/dialog","N/url","N/runtime","N/search"],(e,t,a,i,s,r,c,l)=>{const o=t=>{const a=e.client(r).pageInit(t);return a},u=(t,a,c,l,o,u)=>{try{e.client().mask.showLoadingMask(c);const d=a.scriptConfig.clientScriptModuleName;if(!o||0==o.length){null==u&&(u=e.constant.suitelet.SUBLIST_ID);const i=a.sublistConfig.find(e=>e.id==u);o=e.client().sublist.getSublistDatalist(t,i.fields,u)}if(0==o.length)return e.client().mask.clearLoadingMask(c),void s.alert({title:"错误提示",message:"请至少选择一条记录"});i.post.promise({url:e.https(i,r).getSuiteletUrl(a.scriptConfig.suiteletScriptName),body:e.https(i).getRequestBody(l,{pageSource:d,subdataList:o}),headers:{Accept:"*/*","Content-Type":"application/json"}}).then(function(u){const d=JSON.parse(u.body);if("fail"==d.status)e.client().mask.clearLoadingMask(c),s.alert({title:"提示",message:d.message});else{const u=d.data;if(log.debug("saveRecord-responseData",u),null==u||e.isNullOrEmpty(u.taskId))n(t,a,c,u,l);else{e.client().mask.clearLoadingMask(c);let d="任务执行中...",_=o.length;u.dataCount&&(_=u.dataCount);const m=u.taskId,f=a.scriptConfig.suiteletScriptName,v=e.task(null,i).createReduceMessage(d,_,f,m);try{let o=5e3;const d=parseInt(_/50)+1;o*=d,o>3e4&&(o=3e4),o<1e4&&(o=1e4);let p=0;const g=setInterval(function(){if(p++,p>100)return v.hidden(),v=message.create({title:title,message:"任务执行时间超长，请刷新页面重试！",type:message.Type.CONFIRMATION}),v.show(),void clearInterval(g);const o=e.https(i,r).post(f,"getReduceStatus",{taskId:m});if("fail"==o.status)return clearInterval(g),void s.alert({title:"错误提示",message:o.message});{const e=o.data.taskStatus;"COMPLETE"!=e&&"FAILED"!=e||(clearInterval(g),n(t,a,c,u,l))}},o)}catch(e){log.error("error",e),s.alert({title:"错误提示",message:e.message})}}}}).catch(function(t){e.client().mask.clearLoadingMask(c),s.alert({title:"错误提示",message:t})})}catch(t){console.log(t),e.client().mask.clearLoadingMask(c),s.alert({title:"错误提示",message:t.message})}},n=(t,a,i,c,l)=>{e.client().mask.clearLoadingMask(i),s.alert({title:"提示",message:"操作成功"}),setTimeout(()=>{let i=a.fieldGroupConfig.find(e=>e.isFilterGroup);i.suiteletScriptName=a.scriptConfig.suiteletScriptName,e.client(r).event.doSearch(t,"custpage_button_search",i)},500)},d=(t,a)=>{let s=t.type;const r=t.data;if("getReduceStatus"==s)return L(a,r);let c=e.https().getSuccessResponse(),l=r.subdataList;if(l.length>5){l=l.map(e=>(e.operator_type=s,e));const t={custscript_bws_plat_params:{subdataList:l}},r=e.task(a,i).createTask(t);return c.data={taskId:r},c}const o=_(l,s,a);return c.data={recordIds:o},c},_=(e,t)=>{const a=[];return e.forEach(e=>{const i=m(e,t);a.push(i)}),a},m=(e,t)=>"doSaveAssemblyBuildCost"==t?f(e):"doCreateSalesInvoice"==t?p(e):"doSettingInvoice"==t?g(e):"doSaveCostAccount"==t?b(e):"doSaveCPCostAccount"==t?y(e):null,f=i=>{log.debug("doSaveAssemblyBuildCost---data.internalid",i.internalid);const s=t.load({type:"assemblybuild",id:i.internalid,isDynamic:!0}),r=e.date(a).stringToDate(i.trandate);s.setValue({fieldId:"custbody_ca_build_date_allocation",value:r}),s.setValue({fieldId:"custbody_ca_quota_allocation_build",value:i.custbody_ca_quota_allocation_build}),s.setValue({fieldId:"custbody_ca_cost_allocationed",value:i.custbody_ca_cost_allocationed});const c=I(),l=s.getLineCount({sublistId:"component"});for(let e=0;e<l;e++){const t=s.getSublistValue({sublistId:"component",fieldId:"item",line:e});c[t]&&(s.selectLine({sublistId:"component",line:e}),s.setCurrentSublistValue({sublistId:"component",fieldId:"quantity",value:i[c[t]]}),s.commitLine({sublistId:"component"}))}s.save({ignoreMandatoryFields:!0}),v(i.share_record_internalid,i.internalid)},v=(a,i)=>{if(a&&i)try{const s=[{id:"internalid"},{id:"custrecord_ca_cost_share_record_mid",label:"关联主表",filter:{values:a}},{id:"custrecord_ca_cost_share_assemblybuild",label:"装配件构建",filter:{values:i}}],r=e.search(l).getSearchResultDataList("customrecord_ca_cost_share_plat_reitem",s,1,10);r.length>0&&t.delete({type:"customrecord_ca_cost_share_plat_reitem",id:r[0].internalid})}catch(e){log.error("deleteCostShareRecordItem",e)}},p=a=>{const i=[],s=a.subdataList;s.forEach(e=>{i.push({item:e.item,quantity:e.quantity_invoice,rate:e.rate,solineid:e.solineid})});const r={maindata:{createdfrom:a.createdfrom},itemlist:i},c=e.api(t).doCreateSalesInvoice(r);if("success"==c.status){const e=c.data.internalid,a=s[0],i=t.create({type:"customrecord_ica_if_main",isDynamic:!0});i.setValue({fieldId:"custrecord_ica_if_doc",value:a.internalid});const r="recmachcustrecord_ica_if_doc_main";return s.forEach(t=>{i.selectNewLine({sublistId:r}),i.setCurrentSublistValue({sublistId:r,fieldId:"custrecord_sc_relation_transaction",value:a.internalid}),i.setCurrentSublistValue({sublistId:r,fieldId:"custrecord_sc_relation_invoice_number",value:e}),i.setCurrentSublistValue({sublistId:r,fieldId:"custrecord_sc_relation_item_code",value:t.item}),i.setCurrentSublistValue({sublistId:r,fieldId:"custrecord_sc_relation_invoice_qty",value:t.quantity_invoice}),i.setCurrentSublistValue({sublistId:r,fieldId:"custrecord_sc_relation_item_if_line",value:t.solineid}),i.commitLine({sublistId:r})}),i.save({ignoreMandatoryFields:!0}),e}return null},g=e=>{const a=t.load({type:"invoice",id:e.internalid,isDynamic:!0});a.setValue({fieldId:"custbody_sc_cogs_carry_over",value:!0});const i=e.subdataList;let s=0;return i.forEach(e=>{s=parseFloat(s)+(parseFloat(e.settingamount)||0)}),s=parseFloat(s).toFixed(2),a.setValue({fieldId:"custbody_sc_over_cost_amount",value:s}),a.save({ignoreMandatoryFields:!0}),i.forEach(e=>{const a=t.load({type:"customrecord_sc_tran_relation_invoice",id:e.sc_reltranaction_internalid});a.setValue({fieldId:"custrecord_sc_relation_trans_cost_amt",value:e.settingamount}),a.setValue({fieldId:"custrecord_sc_relation_invo_carry_over",value:!0}),a.save({ignoreMandatoryFields:!0})}),log.debug("doSettingInvoice",a.id),a.id},b=i=>{const s=[{id:"internalid"},{id:"custrecord_ica_icr_build_number",label:"完工单号",filter:{values:i.internalid}}],r=e.search(l).getSearchResultDataList("customrecord_ica_item_cost_record",s,1,10);let c=null;if(r.length>0){const e=r[0].internalid;c=t.load({type:"customrecord_ica_item_cost_record",id:e,isDynamic:!0})}else c=t.create({type:"customrecord_ica_item_cost_record",isDynamic:!0});c.setValue({fieldId:"custrecord_ica_icr_wo_number",value:i.wointernalid});let o=i.trandate;o&&(o=e.date(a).stringToDate(o)),c.setValue({fieldId:"custrecord_ica_icr_build_date",value:o}),c.setValue({fieldId:"custrecord_ica_icr_build_number",value:i.internalid}),c.setValue({fieldId:"custrecord_ica_icr_item_code",value:i.item}),c.setValue({fieldId:"custrecord_ica_icr_item_name",value:i.displayname}),c.setValue({fieldId:"custrecord_ica_icr_item_size",value:i.custitem_hc_item_size}),c.setValue({fieldId:"custrecord_ica_icr_units",value:i.unitid}),c.setValue({fieldId:"custrecord_ica_icr_qty",value:i.quantity}),c.setValue({fieldId:"custrecord_ica_icr_total_material",value:i.formulacurrency_1}),c.setValue({fieldId:"custrecord_ica_icr_total_labor",value:i.formulacurrency_2}),c.setValue({fieldId:"custrecord_ica_icr_total_manufacture",value:i.formulacurrency_3}),c.setValue({fieldId:"custrecord_ica_icr_total_outexpense",value:i.formulacurrency_4}),c.setValue({fieldId:"custrecord_ica_icr_pre_material",value:i.formulacurrency_1_unit}),c.setValue({fieldId:"custrecord_ica_icr_pre_labor",value:i.formulacurrency_2_unit}),c.setValue({fieldId:"custrecord_ica_icr_pre_manufacture",value:i.formulacurrency_3_unit}),c.setValue({fieldId:"custrecord_ica_icr_total_pre_outexpense",value:i.formulacurrency_4_unit}),c.setValue({fieldId:"custrecord_ica_icr_subsidiary",value:i.subsidiary}),c.setValue({fieldId:"custrecord_ica_icr_bom_rev",value:i.bomrevision_internalid}),c.setValue({fieldId:"custrecord_ica_icr_bom_type",value:i.bomtype}),c.setValue({fieldId:"custrecord_ica_icr_location",value:i.location}),c.save({ignoreMandatoryFields:!0})},y=a=>{const i=[{id:"internalid"},{id:"custrecord_ica_month_subsidiary",label:"子公司",filter:{values:a.subsidiary2}},{id:"custrecord_ica_relation_assembly",label:"货品",filter:{values:a.item2}},{id:"custrecord_ica_month",label:"月份",filter:{values:a.month}}],s=e.search(l).getSearchResultDataList("customrecord_ica_cost_regist",i,1,10);let r=null;if(s.length>0){const e=s[0].internalid;r=t.load({type:"customrecord_ica_cost_regist",id:e,isDynamic:!0})}else r=t.create({type:"customrecord_ica_cost_regist",isDynamic:!0});r.setValue({fieldId:"custrecord_ica_month_subsidiary",value:a.subsidiary2});let c=h(a.month);r.setValue({fieldId:"custrecord_ica_accounting",value:c}),r.setValue({fieldId:"custrecord_ica_relation_assembly",value:a.item2}),r.setValue({fieldId:"custrecord_ica_pre_month_material",value:a.formulacurrency_1_unit2}),r.setValue({fieldId:"custrecord_ica_pre_month_labor",value:a.formulacurrency_2_unit2}),r.setValue({fieldId:"custrecord_ica_pre_month_manufacturing",value:a.formulacurrency_3_unit2}),r.setValue({fieldId:"custrecord_ica_pre_month_outexpense",value:a.formulacurrency_4_unit2}),r.setValue({fieldId:"custrecord_ica_pre_month_cost",value:a.total_unitcost2}),r.setValue({fieldId:"custrecord_ica_month",value:a.month}),r.save({ignoreMandatoryFields:!0})},h=t=>{const a={"01":"Jan","02":"Feb","03":"Mar","04":"Apr","05":"May","06":"Jun","07":"Jul","08":"Aug","09":"Sep",10:"Oct",11:"Nov",12:"Dec"},i=t.split("-"),s=a[i[1]]+" "+i[0],r=[{id:"isinactive",search:{type:"none"},filter:{values:"F"}},{id:"periodname",label:"期间名称",filter:{values:s}},{id:"internalid",label:"内部id"}],c=e.search(l).getSearchAllResultDataList("accountingperiod",r,1,10);return c.length>0?c[0].internalid:null},I=()=>{const e="7336086"==c.accountId?{94560:"custpage_ca_machine_cost",94559:"custpage_ca_person_cost"}:{84393:"custpage_ca_machine_cost",84394:"custpage_ca_person_cost"};return e},S=t=>{const a=[{id:"custrecord_sc_relation_invoice_number",alias:"invoice",label:"发票号",search:{type:"valueText"}},{id:"mainline",join:"custrecord_sc_relation_invoice_number",search:{type:"none"},filter:{values:"T"}},{id:"postingperiod",label:"过账期间",join:"custrecord_sc_relation_invoice_number",search:{type:"none"},filter:{values:t}}];let i=e.search(l).getSearchAllResultDataList("customrecord_sc_tran_relation_invoice",a,1,1e3);const s={};i.forEach(e=>{s[e.invoice]=e.invoice_display_name});const r=[{value:"",text:""}];for(const e in s)r.push({value:e,text:s[e]});return r},V=t=>{const a=[{value:"",text:""}];if(!t)return a;const i=[{id:"internalid"},{id:"mainname",filter:{values:t}}],s=e.savedSearch(l).getSearchAllResultDataList("customsearch_sc_gogs_salesorder",i,1,1e3);return s.forEach(e=>{a.push({value:e.internalid,text:e.tranid})}),a},C=t=>{const a=[{id:"entity",label:"内部id",search:{type:"valueText"}},{id:"subsidiary",label:"所属公司",filter:{values:t}}];let i=e.search(l).getSearchAllResultDataList("customersubsidiaryrelationship",a,1,1e3);const s=[{value:"",text:""}];return i.forEach(e=>{s.push({value:e.entity,text:e.entity_display_name})}),s},L=(t,a)=>e.task(t,i).getReduceStatus(a.taskId);return{pageInit:o,saveRecord:u,onRequest:d,doOperatorData:m,getReduceStatus:L,getAssemblybuildCostItem:I,getScRelationTransaction:S,getScSalesorderOptions:V,getSubsidiayCustomer:C}});